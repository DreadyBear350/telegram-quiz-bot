import logging
import time
from telegram import Poll, Update, InputMediaPhoto
from telegram.ext import Updater, CommandHandler, PollAnswerHandler, PollHandler, CallbackContext

# ==== –í–°–¢–ê–í–¨ –°–í–û–ô –¢–û–ö–ï–ù ====
TOKEN = "8537067418:AAF6FR2KAvaf0oED12JP7zFv4u0Sjsi9CNA"

# ==== –í–û–ü–†–û–°–´ ====
QUESTIONS = [
    {
        "question": "–í–æ–ø—Ä–æ—Å ‚Ññ1\n–í –∫–∞–∫–æ–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω–æ–π —à–∫–æ–ª–µ –ø–æ—è–≤–∏–ª—Å—è –ø–µ—Ä–≤—ã–π –∫–∞–±–∏–Ω–µ—Ç Easy School?",
        "options": ["–°–û–® ‚Ññ24", "–°–û–® ‚Ññ77", "–°–û–® ‚Ññ19"],
        "correct_id": 1,
        "explanation":
            "–ò–º–µ–Ω–Ω–æ –≤ —à–∫–æ–ª–µ ‚Ññ77 –≤ –ü–µ—Ä–≤–æ–º–∞–π—Å–∫–æ–º –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω–µ –≤ 2000 –≥–æ–¥—É –Ω–∞—á–∞–ª–∞—Å—å –Ω–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è ‚Äî "
            "—Å –æ–¥–Ω–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞. –ê —Å–µ–π—á–∞—Å —É –Ω–∞—Å 13 —à–∫–æ–ª –≤ –ò—Ä–∫—É—Ç—Å–∫–µ –∏ –ê–Ω–≥–∞—Ä—Å–∫–µ!"
    },
    {
        "question": "–í–æ–ø—Ä–æ—Å ‚Ññ2\n–í –∫–∞–∫–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö –º—ã –ù–ï –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–π –≤ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫?",
        "options": [
            "–î—É–±–∞–π, –ú–∞–Ω–∏–ª–∞, –ì–æ–Ω–∫–æ–Ω–≥",
            "–°–µ—É–ª, –ê–±—É-–î–∞–±–∏, –®—ç–Ω—å—è–Ω",
            "–•–∞–Ω–æ–π, –ë—Ä–∞–∑–∏–ª–∏–∞, –î–∂–∞–∫–∞—Ä—Ç–∞"
        ],
        "correct_id": 2,
        "explanation":
            "–•–∞–Ω–æ–π, –ë—Ä–∞–∑–∏–ª–∏–∞ –∏ –î–∂–∞–∫–∞—Ä—Ç–∞ ‚Äî –≤ —ç—Ç–∏—Ö –≥–æ—Ä–æ–¥–∞—Ö –Ω–∞–º —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ "
            "–≤ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫. –ê –ø–æ–∫–∞ –∫–∞–∂–¥–æ–µ –ª–µ—Ç–æ (–∏ –¥–∞–∂–µ –∑–∏–º—É) –Ω–∞—à–∏ —Å—Ç—É–¥–µ–Ω—Ç—ã –∏–º–µ—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å "
            "–ø—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å —è–∑—ã–∫ –≤ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∞—Ö: –æ—Ç –ê–∑–∏–∏ –¥–æ –∞—Ä–∞–±—Å–∫–∏—Ö —Å—Ç—Ä–∞–Ω –±–ª–∞–≥–æ–¥–∞—Ä—è "
            "–ø—Ä–æ–µ–∫—Ç—É ¬´Easy Travel¬ª."
    },
    {
        "question": "–í–æ–ø—Ä–æ—Å ‚Ññ3\n–ö–∞–∫–∏–µ –∏–∑ —ç—Ç–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –≤ Easy School?",
        "options": [
            "–î–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –ü–∞—Ç—Ä–∏–∫–∞, –•—ç–ª–ª–æ—É–∏–Ω, Christmas Party",
            "–Ø–±–ª–æ—á–Ω—ã–π —Å–ø–∞—Å, –î–µ–Ω—å –æ—Ç–∫–∞–∑–∞ –æ—Ç –¥–∏–µ—Ç, –î–µ–Ω—å –∞—Ä–±—É–∑–∞",
            "–î–µ–Ω—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞, –ü—Ä–∞–∑–¥–Ω–∏–∫ –∫–∏—Ç–∞–π—Å–∫–æ–π –∑–∞–≤–∞—Ä–∫–∏, –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –¥–µ–Ω—å –∫–æ—Ä–µ–π—Å–∫–∏—Ö –ø–µ–ª—å–º–µ—à–µ–∫"
        ],
        "correct_id": 0,
        "explanation":
            "–ó–∞ 25 –ª–µ—Ç –º—ã –ø—Ä–æ–≤–µ–ª–∏ –º–Ω–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: –æ—Ç –•—ç–ª–ª–æ—É–∏–Ω–∞ –¥–æ –†–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–∏—Ö –≤–µ—á–µ—Ä–∏–Ω–æ–∫, "
            "–æ—Ç —Å–µ–º–∏–Ω–∞—Ä–æ–≤ –ø–æ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –ø—Ä–æ–∫–∞—á–∫–∏ soft-skills —É –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤, "
            "–æ—Ç –∫–∏–Ω–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–æ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –≤–µ—á–µ—Ä–∏–Ω–æ–∫. –ê –≤–ø–µ—Ä–µ–¥–∏ –ø—Ä–∏–¥—É–º–∞–Ω–æ –µ—â—ë –º–Ω–æ–≥–æ –∫—Ä—É—Ç—ã—Ö –∏–≤–µ–Ω—Ç–æ–≤!"
    },
    {
        "question": "–í–æ–ø—Ä–æ—Å ‚Ññ4\n–ö–∞–∫–æ–π –∫—É—Ä—Å –µ—Å—Ç—å –≤ Easy School?",
        "options": [
            "–¢—É—Ä–µ—Ü–∫–∏–π —è–∑—ã–∫",
            "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º—É —ç–∫–∑–∞–º–µ–Ω—É –ø–æ –º–æ–Ω–≥–æ–ª—å—Å–∫–æ–º—É",
            "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ IELTS"
        ],
        "correct_id": 2,
        "explanation":
            "–í–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏ –º–æ–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ —Å–¥–∞—á–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ —ç–∫–∑–∞–º–µ–Ω–∞ –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É —è–∑—ã–∫—É, "
            "–∞ –≤–æ—Ç —Ç—É—Ä–µ—Ü–∫–æ–º—É –∏ –º–æ–Ω–≥–æ–ª—å—Å–∫–æ–º—É –ø–æ–∫–∞ –Ω–µ –æ–±—É—á–∞–µ–º."
    },
    {
        "question": "–í–æ–ø—Ä–æ—Å ‚Ññ5\n–ö–∞–∫–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è –º—ã –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ–º—Å—è?",
        "options": [
            "Edutainment: –æ–±—É—á–µ–Ω–∏–µ + —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –ø–æ–¥–∞–Ω–Ω–∞—è –≤ –∏–≥—Ä–æ–≤–æ–π —Ñ–æ—Ä–º–µ, –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ª—É—á—à–µ!",
            "–§—ç–Ω—à—É–π: –µ—Å–ª–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –≤—Å—ë –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö, —Ç–æ –≤ –≥–æ–ª–æ–≤–µ —Ç–æ–∂–µ —Ä–∞–∑–ª–æ–∂–∏—Ç—Å—è –ø–æ –ø–æ–ª–æ—á–∫–∞–º.",
            "No sitting down: —Å—Ç–æ—è –Ω–µ —Ç–æ–ª—å–∫–æ –±–æ–ª—å—à–µ –≤–ª–µ–∑–µ—Ç, –Ω–æ –∏ –±–æ–ª—å—à–µ –∑–∞–ø–æ–º–Ω–∏—Ç—Å—è!"
        ],
        "correct_id": 0,
        "explanation":
            "–û–±—É—á–µ–Ω–∏–µ + —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ = —É—á—ë–±–∞ –±–µ–∑ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —Å—Ç–µ—Å–Ω–µ–Ω–∏—è, —Ä—É—Ç–∏–Ω—ã –∏ —Å–∫—É–∫–∏. "
            "–≠—Ç–æ—Ç –ø—Ä–∏–Ω—Ü–∏–ø —É–∂–µ –¥–æ–∫–∞–∑–∞–ª —Å–≤–æ—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –æ–≥—Ä–æ–º–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤!"
    }
]

# ==== –§–ò–ù–ê–õ–¨–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ====
FINAL_MESSAGES = [
    # 0 ‚Äî –æ–±—â–µ–µ ¬´—Ç—ã —á–∞—Å—Ç—å –∏—Å—Ç–æ—Ä–∏–∏¬ª
    "–í —ç—Ç–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö —Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∞—è —á–∞—Å—Ç—å –Ω–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ –Ω–∞–º —Ç–∞–∫ –ø—Ä–∏—è—Ç–Ω–æ, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è ‚Äî —Ç—ã –µ—ë —á–∞—Å—Ç—å üíñ ! "
    "–ì–æ—Ä–¥–∏–º—Å—è –∏ –≤–æ—Å—Ö–∏—â–∞–µ–º—Å—è —Ç–µ–º, —á—Ç–æ —Ç—ã –Ω–µ –ø–µ—Ä–µ—Å—Ç–∞—ë—à—å —É—á–∏—Ç—å—Å—è –∏ –≤–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –≤ —Å–≤–æ—ë —Ä–∞–∑–≤–∏—Ç–∏–µ. –õ–æ–≤–∏ –æ–±–µ—â–∞–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏ üëá",

    # 1 ‚Äî –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ –î–†
    "6 –¥–µ–∫–∞–±—Ä—è –ø—Ä–∞–∑–¥–Ω—É–µ–º –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–∏–≥–ª–∞—à–∞–µ–º —Ç–µ–±—è –Ω–∞ –Ω–µ–≥–æ!\n"
    "‚ú®14:00, –î–æ–º –ú–æ–ª–æ–¥—ë–∂–∏ (—É–ª. –î–µ–∫–∞–±—Ä—å—Å–∫–∏—Ö –°–æ–±—ã—Ç–∏–π, 102/1). "
    "–ë–µ—Ä–∏ —Å–≤–æ–µ–≥–æ +1, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ —Å—Å—ã–ª–∫–µ, –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –±—É–¥–µ—Ç–µ:",

    # 2 ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—ã + –∫–∞–Ω–∞–ª
    "–í—Ç–æ—Ä–æ–π –ø–æ–¥–∞—Ä–æ–∫ ‚Äî —É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–≤ —Ç–≤–æ–µ–π —à–∫–æ–ª—ã!\n"
    "–ó–∞–≥–ª—è–¥—ã–≤–∞–π –∫ –Ω–∏–º, –≥–æ–≤–æ—Ä–∏ –∫–æ–¥–æ–≤–æ–µ ¬´–Ø –∑–∞ –ø–æ–¥–∞—Ä–∫–æ–º –∑–∞ Easy-–∫–≤–∏–∑¬ª, –∏ –æ–Ω–∏ –≤—Ä—É—á–∞—Ç —Ç–µ–±–µ –∫–æ–µ-—á—Ç–æ –Ω–µ–±–æ–ª—å—à–æ–µ, –Ω–æ –ø—Ä–∏—è—Ç–Ω–æ–µ.\n\n"
    "–ò —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –æ—Ç –Ω–∞—Å ‚Äî –±—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ä–∞—Ö –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ —á–∞—â–µ üíú "
    "–ó–∞–≥–ª—è–¥—ã–≤–∞–π –≤ –Ω–∞—à —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª, —Ç–∞–º –º–Ω–æ–≥–æ –ø–æ–ª–µ–∑–Ω–æ–≥–æ –∏ –≤–µ—Å—ë–ª–æ–≥–æ https://t.me/easyschoolyear1"
]

# —Å—é–¥–∞ –∫–ª–∞–¥—ë–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –Ω–∞ –î–†
FINAL_PHOTOS = [
    "https://i.yapx.ru/cNon0.jpg",
    "https://i.yapx.ru/cNoou.jpg",
]

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

open_polls = {}  # poll_id -> {"chat_id": ..., "index": ...}


def send_question(chat_id, index, context: CallbackContext):
    q = QUESTIONS[index]
    msg = context.bot.send_poll(
        chat_id=chat_id,
        question=q["question"],
        options=q["options"],
        type=Poll.QUIZ,
        correct_option_id=q["correct_id"],
        is_anonymous=False,
    )
    open_polls[msg.poll.id] = {"chat_id": chat_id, "index": index}
    logger.info("–û—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤–æ–ø—Ä–æ—Å #%s, poll_id=%s", index + 1, msg.poll.id)


def start(update: Update, context: CallbackContext):
    chat_id = update.effective_chat.id
    context.bot.send_message(
        chat_id,
        "–ü—Ä–∏–≤–µ—Ç! –í —ç—Ç–æ–º –≥–æ–¥—É Easy School –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è 25 –ª–µ—Ç ‚Äî –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è —É –Ω–∞—Å –ø—Ä–æ–∏–∑–æ—à–ª–æ —Ç–∞–∫ –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ!\n\n"
        "–ê –¥–∞–≤–∞–π –æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è –ø–æ–±–ª–∏–∂–µ? –í—Å—ë –ø—Ä–æ—Å—Ç–æ ‚Äî —Å —Ç–µ–±—è –æ—Ç–≤–µ—Ç—ã –Ω–∞ —ç—Ç–æ—Ç –º–∞–ª–µ–Ω—å–∫–∏–π –∫–≤–∏–∑, –∞ —Å –Ω–∞—Å ‚Äî –ø—Ä–∏—è—Ç–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –∑–∞ —ç—Ç–æ.\n\n"
        "–ü–æ–µ—Ö–∞–ª–∏?"
    )
    send_question(chat_id, 0, context)


def _advance(chat_id, index, context: CallbackContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏ –ª–∏–±–æ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –ª–∏–±–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    explanation = QUESTIONS[index]["explanation"]
    context.bot.send_message(chat_id, explanation)

    next_index = index + 1
    if next_index < len(QUESTIONS):
        time.sleep(1.5)
        send_question(chat_id, next_index, context)
    else:
        # —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è + –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é –Ω–∞ –î–†
        for i, msg in enumerate(FINAL_MESSAGES):
            time.sleep(1.2)
            context.bot.send_message(chat_id, msg)

            # –∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é (FINAL_MESSAGES[1]) –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
            if i == 1 and FINAL_PHOTOS:
               media = [InputMediaPhoto(photo) for photo in FINAL_PHOTOS]
               context.bot.send_media_group(chat_id=chat_id, media=media)



def handle_poll_answer(update: Update, context: CallbackContext):
    answer = update.poll_answer
    if not answer:
        return

    pid = answer.poll_id
    logger.info("handle_poll_answer: –æ—Ç–≤–µ—Ç –Ω–∞ poll_id=%s –æ—Ç user_id=%s", pid, answer.user.id)

    info = open_polls.pop(pid, None)
    if not info:
        logger.info("handle_poll_answer: poll_id=%s –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ open_polls", pid)
        return

    chat_id = info["chat_id"]
    index = info["index"]
    _advance(chat_id, index, context)


def handle_poll_update(update: Update, context: CallbackContext):
    poll = update.poll
    if not poll:
        return

    pid = poll.id
    logger.info(
        "handle_poll_update: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–∞ %s, total_voter_count=%s",
        pid, poll.total_voter_count
    )

    info = open_polls.get(pid)
    if not info:
        logger.info("handle_poll_update: poll_id=%s –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ open_polls", pid)
        return

    if poll.total_voter_count < 1:
        return

    info = open_polls.pop(pid, None)
    if not info:
        return

    chat_id = info["chat_id"]
    index = info["index"]
    _advance(chat_id, index, context)


def main():
    updater = Updater(TOKEN, use_context=True)

    dp = updater.dispatcher
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(PollAnswerHandler(handle_poll_answer))
    dp.add_handler(PollHandler(handle_poll_update))

    updater.start_polling(allowed_updates=["message", "poll", "poll_answer"])
    updater.idle()


if __name__ == "__main__":
    main()
